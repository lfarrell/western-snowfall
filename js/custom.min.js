queue().defer(d3.json,"analysis/ca_munged_data.json").defer(d3.json,"js/ca-all.json").await(function(l,m,A){function F(a,d){var b=d3.time.scale().range([0,a]);b.domain(d3.extent(d,function(a){return a.date}));return b}function G(a,d){var b=d3.scale.ordinal().rangeRoundBands([0,a],.05);b.domain(d);return b}function H(a,d,b){return d3.scale.quantile().domain(_.pluck(d,b)).range(a)}function I(a,d,b){var c,f;b=window.innerWidth;c=b-15;150>c?(c=10,f="vertical"):350>c?(c=20,f="vertical"):500>c?(c=40,f=
    "vertical"):(c=700>c?50:805>c?57:1E3>c?65:70,f="horizontal");var e="vertical"===f?200:75;a=d3.select(a).attr("width",b).attr("height",e);a.append("g").attr("class","legendQuant").translate([20,0]).attr("width",b).attr("height",e);d=d3.legend.color().shapeWidth(c).orient(f).labelFormat(d3.format(".1f")).scale(d);a.select(".legendQuant").call(d)}function J(a,h){var b=window.innerWidth-d.right-d.left,c=/y/.test(h),f,e;150>b?(f=3.3,e=3):350>b?(f=6,e=9):500>b?e=f=9:700>b?(f=11,e=9):(f=15,e=17);c&&420>=
    b?f=2.5:c&&700>=b?f=7:c&&1020>=b&&(f=10);a&&420>=b?f=1.5:a&&800>=b?f=2:a&&(f=3);return{radius:f,ticks:e}}function B(a){switch(a){case 0:return"January";case 1:return"February";case 2:return"March";case 3:return"April";case 4:return"May";case 5:return"June";case 6:return"July";case 7:return"August";case 8:return"September";case 9:return"October";case 10:return"November";case 11:return"December";default:return"unknown"}}var d={top:50,right:130,bottom:25,left:105},p=d3.time.format("%m/%Y").parse,n=d3.time.format("%Y").parse,
    q=d3.time.format("%m").parse,v=d3.format(".1f"),r=250-d.top-d.bottom,h=400-d.top-d.bottom,K="#a50026 #d73027 #f46d43 #fdae61 #fee090 #ffffbf #e0f3f8 #abd9e9 #74add1 #4575b4 #313695".split(" "),x=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);m.forEach(function(a){/\//.test(a.date)?a.date=p(a.date):/y/.test(a.type)?a.date=n(a.date):a.date=q(a.date)});var C=d3.select("#year").append("svg"),D=d3.select("#states_cal").append("svg"),y=d3.select("#river_year_chart").append("svg"),
    L=d3.select("#map").append("svg").append("g").attr("id","base_map");l=_.debounce(function(){function a(a,t,g,c,u,E){var w=J(c,g),e=w.radius,z=500>=b?"%y":"%Y",l=c?10:0,m=c||/river/.test(g)?5:0,n=_.pluck(_.uniq(a,function(a){return a.elev}),"elev").reverse(),k=n.length;/river/.test(g)?(c=f/1.5,d.top=25):c=f;var k=7==k?h:6==k?.9*h:5==k?.8*h:4==k?.6*h:3==k?.5*h:2==k?.35*h:.18*h,p=F(c,a),q=G(k,n),w=d3.svg.axis().scale(p).orient("top").ticks(w.ticks).tickFormat(d3.time.format(z)),z=d3.svg.axis().scale(q).orient("left").tickFormat(d3.format(",d"));
    t.attr("height",k+d.top+d.bottom).attr("width",c+d.right+d.left);t.append("g").attr("class","x axis").translate([d.left,d.top]);d3.select(g+" g.x").call(w);t.append("g").attr("class","y axis").translate([d.left-25,d.top]);d3.select(g+" g.y").call(z);var r=H(K,a,u);I(g+"-legend",r,c);a=t.selectAll("circle").data(a);a.enter().append("circle");a.translate([d.left,d.top+20]).on("mouseover touchstart",function(a){var c;c=/y/.test(g)?a.date.getFullYear():/m/.test(g)?B(a.date.getMonth()):B(a.date.getMonth())+
        " "+a.date.getFullYear();x.transition().duration(100).style("opacity",.9);x.html('<h4 class="text-center">'+c+'</h4><h5  class="text-center">Snow/Water Equivalence</h5><ul class="list-unstyled"<li>Elevation: '+a.elev+"+ feet</li><li>Total Sites: "+a.total+"</li><li>Water Mean: "+v(a.wm)+" inches</li><li>Water Median: "+v(a.wmd)+" inches</li><li>Snow Mean: "+v(a.sm)+" inches</li><li>Snow Median: "+v(a.smd)+" inches</li></ul>").style("top",d3.event.pageY+38+"px").style("left",d3.event.pageX-55+"px");
        d3.select(this).attr("r",1.5*e)}).on("mouseout touchend",function(a){x.transition().duration(250).style("opacity",0);d3.select(this).attr("r",e)});a.transition().duration(1E3).ease("sin-in-out").style("fill",function(a){return r(a[u])}).attr("cx",function(a){return p(a.date)-l}).attr("cy",function(a){return q(a.elev)+m}).attr("r",e);a.exit().remove();a="sm"===u?"Snow Average":"smd"===u?"Snow Median":"wm"===u?"Water Average":"Water Median";d3.select(g+"-note").text(a);E&&(t.append("marker").attr("id",
        "arrow").attr("viewBox","-10 -10 20 20").attr("markerWidth",11).attr("markerHeight",11).attr("orient","auto").append("path").attr("d","M-6.75,-6.75 L 0,0 L -6.75,6.75"),d3.selectAll(g+" g.annotations").remove(),a=d3.swoopyDrag().x(function(a){return p(a.xVal)}).y(function(a){return q(a.yVal)}).draggable(0),a.annotations(E),t.append("g.annotations").call(a),d3.selectAll(g+" .annotations path").attr("marker-end","url(#arrow)"))}function l(a,c,g){var d="American;Eel;Feather;Kaweah;Kern;Kings;Lk Tahoe;McCloud;Merced;Mokelumne;Mono Lk;Owens;Pit;Sacramento;San Joaquin;Scott;Shasta;Stanislaus;Stony Cr;Susan;Trinity;Truckee;Tule;Tuolumne;Walker;Yuba".split(";"),
    b=1,b=d3.geo.mercator().scale(b).translate([0,0]),f=d3.geo.path().projection(b),e=f.bounds(c),b=.97/Math.max((e[1][0]-e[0][0])/a,(e[1][1]-e[0][1])/r),e=[(a-b*(e[1][0]+e[0][0]))/2,(r-b*(e[1][1]+e[0][1]))/2],b=d3.geo.mercator().scale(b).translate(e),f=f.projection(b),b=d3.behavior.zoom().scaleExtent([1,3]).on("zoom",function(){h.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")});d3.behavior.drag().origin(function(a){return a}).on("drag",function(a){d3.event.sourceEvent.stopPropagation();
    d3.select(this).attr("x",a.x=d3.event.x).attr("y",a.y=d3.event.y)});d3.select("#map svg").attr("height",r).attr("width",a).call(b);var h=L.selectAll("path").data(c.features);h.enter().append("path");h.attr("d",f).style("fill",function(a){return a.properties.Name===g?"red":"none"}).style("opacity",.7).style("stroke",function(a){return a.properties.Name===g?"red":-1!==_.indexOf(d,a.properties.Name)?"none":"white"})}var b=window.innerWidth,c,f;480>=b?(f=b-d.left-50,c=b):(f=b-d.left-d.right,c=Math.floor(b/
    3.3));var e=m.filter(function(a){return"yew"===a.type}),p=[{xVal:n("2005"),yVal:8E3,path:"M54,-75L95,100",text:"Max Snow Levels",textOffset:[6,-86]},{xVal:n("2015"),yVal:4E3,path:"M131,101L118,82",text:"Min Snow Levels",textOffset:[100,119]}],q=[{xVal:n("2011"),yVal:8E3,path:"M70,19L105,156",text:"Max Snow Levels",textOffset:[18,9]},{xVal:n("2015"),yVal:4E3,path:"M131,101L118,82",text:"Min Snow Levels",textOffset:[100,119]}],M=m.filter(function(a){return"dew"===a.type}),N=m.filter(function(a){return"reyw"===
    a.type&&"American"===a.river});a(e,C,"#year",!1,"sm",p);a(M,D,"#states_cal",!0,"sm",q);a(N,y,"#river_year_chart",!1,"sm");l(c,A,"American");d3.selectAll(".btn-group").on("click",function(b){var c=d3.event.target.id,g=c.split("-");b=g[1];var d=!1,c=/s/.test(c),f,e;"river"===g[0]?(f=/_/.test(g[2])?g[2].split("_").map(function(a){_.capitalize(a)}).join(" "):_.capitalize(g[2]),e=c?"reys":"reyw",g=y,c="#river_year_chart"):"year"===g[0]?(e=c?"yes":"yew",g=C,c="#year"):(e=c?"des":"dew",g=D,c="#states_cal",
    d=!0);var h=m.filter(function(a){return void 0!==f?a.type===e&&a.river===f:a.type===e});a(h,g,c,d,b)});d3.select("#river").on("change",function(b){b=this.options[this.selectedIndex].innerHTML;var e=d3.select(this),d=e.prop("value");d3.selectAll("#river_name").text(b);e.prop("value","");b=m.filter(function(a){return"reyw"===a.type&&a.river===d});""!==d&&(d3.selectAll("#rivers button").each(function(){var a=d3.select(this),b=a.attr("id").split("-"),c;3===b.length&&b[2]!==d&&(c=/\s/.test(d)?d.replace(" ",
    "_"):d,a.attr("id",b[0]+"-"+b[1]+"-"+c))}),a(b,y,"#river_year_chart",!1,"sm"),l(c,A,d))});e=d3.selectAll(".row");e.classed("opaque",!1);e.classed("hide",!1);d3.selectAll("#load").classed("hide",!0)});l();window.addEventListener("resize",l)});