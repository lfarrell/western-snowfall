queue().defer(d3.json,"analysis/ca_munged_data.json").defer(d3.json,"js/ca-all.json").await(function(l,m,A){function F(a,b){var c=d3.time.scale().range([0,a]);c.domain(d3.extent(b,function(a){return a.date}));return c}function G(a,b){var c=d3.scale.ordinal().rangeRoundBands([0,a],.05);c.domain(b);return c}function H(a,b,c){return d3.scale.quantile().domain(_.pluck(b,c)).range(a)}function I(a,b,c){var e,f;c=window.innerWidth;e=c-15;150>e?(e=10,f="vertical"):350>e?(e=20,f="vertical"):500>e?(e=40,f=
    "vertical"):(e=700>e?50:805>e?57:1E3>e?65:70,f="horizontal");var d="vertical"===f?200:75;a=d3.select(a).attr("width",c).attr("height",d);a.append("g").attr("class","legendQuant").translate([20,0]).attr("width",c).attr("height",d);b=d3.legend.color().shapeWidth(e).orient(f).labelFormat(d3.format(".1f")).scale(b);a.select(".legendQuant").call(b)}function J(a,h){var c=window.innerWidth-b.right-b.left,e=/y/.test(h),f,d;150>c?(f=3.3,d=3):350>c?(f=6,d=9):500>c?d=f=9:700>c?(f=11,d=9):(f=15,d=17);e&&420>=
    c?f=2.5:e&&700>=c?f=7:e&&1020>=c&&(f=10);a&&420>=c?f=1.5:a&&800>=c?f=2:a&&(f=3);return{radius:f,ticks:d}}function B(a){switch(a){case 0:return"January";case 1:return"February";case 2:return"March";case 3:return"April";case 4:return"May";case 5:return"June";case 6:return"July";case 7:return"August";case 8:return"September";case 9:return"October";case 10:return"November";case 11:return"December";default:return"unknown"}}var b={top:50,right:130,bottom:25,left:105},p=d3.time.format("%m/%Y").parse,n=d3.time.format("%Y").parse,
    q=d3.time.format("%m").parse,v=d3.format(".1f"),r=250-b.top-b.bottom,h=400-b.top-b.bottom,K="#a50026 #d73027 #f46d43 #fdae61 #fee090 #ffffbf #e0f3f8 #abd9e9 #74add1 #4575b4 #313695".split(" "),x=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);m.forEach(function(a){/\//.test(a.date)?a.date=p(a.date):/y/.test(a.type)?a.date=n(a.date):a.date=q(a.date)});var C=d3.select("#year").append("svg"),D=d3.select("#states_cal").append("svg"),y=d3.select("#river_year_chart").append("svg"),
    L=d3.select("#map").append("svg").append("g").attr("id","base_map");l=_.debounce(function(){function a(a,t,g,e,u,E){var w=J(e,g),d=w.radius,z=500>=c?"%y":"%Y",l=e?10:0,m=e||/river/.test(g)?5:0,n=_.pluck(_.uniq(a,function(a){return a.elev}),"elev").reverse(),k=n.length;/river/.test(g)?(e=f/1.5,b.top=25):(e=f,b.top=50);var k=7==k?h:6==k?.9*h:5==k?.8*h:4==k?.6*h:3==k?.5*h:2==k?.35*h:.18*h,p=F(e,a),q=G(k,n),w=d3.svg.axis().scale(p).orient("top").ticks(w.ticks).tickFormat(d3.time.format(z)),z=d3.svg.axis().scale(q).orient("left").tickFormat(d3.format(",d"));
    t.attr("height",k+b.top+b.bottom).attr("width",e+b.right+b.left);t.append("g").attr("class","x axis").translate([b.left,b.top]);d3.select(g+" g.x").call(w);t.append("g").attr("class","y axis").translate([b.left-25,b.top]);d3.select(g+" g.y").call(z);var r=H(K,a,u);I(g+"-legend",r,e);a=t.selectAll("circle").data(a);a.enter().append("circle");a.translate([b.left,b.top+20]).on("mouseover touchstart",function(a){var b;b=/y/.test(g)?a.date.getFullYear():/m/.test(g)?B(a.date.getMonth()):B(a.date.getMonth())+
        " "+a.date.getFullYear();x.transition().duration(100).style("opacity",.9);x.html('<h4 class="text-center">'+b+'</h4><h5  class="text-center">Snow/Water Equivalence</h5><ul class="list-unstyled"<li>Elevation: '+a.elev+"+ feet</li><li>Total Sites: "+a.total+"</li><li>Water Mean: "+v(a.wm)+" inches</li><li>Water Median: "+v(a.wmd)+" inches</li><li>Snow Mean: "+v(a.sm)+" inches</li><li>Snow Median: "+v(a.smd)+" inches</li></ul>").style("top",d3.event.pageY+38+"px").style("left",d3.event.pageX-55+"px");
        d3.select(this).attr("r",1.5*d)}).on("mouseout touchend",function(a){x.transition().duration(250).style("opacity",0);d3.select(this).attr("r",d)});a.transition().duration(1E3).ease("sin-in-out").style("fill",function(a){return r(a[u])}).attr("cx",function(a){return p(a.date)-l}).attr("cy",function(a){return q(a.elev)+m}).attr("r",d);a.exit().remove();a="sm"===u?"Snow Average":"smd"===u?"Snow Median":"wm"===u?"Water Average":"Water Median";d3.select(g+"-note").text(a);E&&(t.append("marker").attr("id",
        "arrow").attr("viewBox","-10 -10 20 20").attr("markerWidth",11).attr("markerHeight",11).attr("orient","auto").append("path").attr("d","M-6.75,-6.75 L 0,0 L -6.75,6.75"),d3.selectAll(g+" g.annotations").remove(),a=d3.swoopyDrag().x(function(a){return p(a.xVal)}).y(function(a){return q(a.yVal)}).draggable(0),a.annotations(E),t.append("g.annotations").call(a),d3.selectAll(g+" .annotations path").attr("marker-end","url(#arrow)"))}function l(a,b,g){var e="American;Eel;Feather;Kaweah;Kern;Kings;Lk Tahoe;McCloud;Merced;Mokelumne;Mono Lk;Owens;Pit;Sacramento;San Joaquin;Scott;Shasta;Stanislaus;Stony Cr;Susan;Trinity;Truckee;Tule;Tuolumne;Walker;Yuba".split(";"),
    c=1,c=d3.geo.mercator().scale(c).translate([0,0]),f=d3.geo.path().projection(c),d=f.bounds(b),c=.97/Math.max((d[1][0]-d[0][0])/a,(d[1][1]-d[0][1])/r),d=[(a-c*(d[1][0]+d[0][0]))/2,(r-c*(d[1][1]+d[0][1]))/2],c=d3.geo.mercator().scale(c).translate(d),f=f.projection(c),c=d3.behavior.zoom().scaleExtent([1,3]).on("zoom",function(){h.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")});d3.behavior.drag().origin(function(a){return a}).on("drag",function(a){d3.event.sourceEvent.stopPropagation();
    d3.select(this).attr("x",a.x=d3.event.x).attr("y",a.y=d3.event.y)});d3.select("#map svg").attr("height",r).attr("width",a).call(c);var h=L.selectAll("path").data(b.features);h.enter().append("path");h.attr("d",f).style("fill",function(a){return a.properties.Name===g?"red":"none"}).style("opacity",.7).style("stroke",function(a){return a.properties.Name===g?"red":-1!==_.indexOf(e,a.properties.Name)?"none":"white"})}var c=window.innerWidth,e,f;480>=c?(f=c-b.left-50,e=c):(f=c-b.left-b.right,e=Math.floor(c/
    3.3));var d=m.filter(function(a){return"yew"===a.type}),p=[{xVal:n("2005"),yVal:8E3,path:"M54,-75L95,100",text:"Max Snow Levels",textOffset:[6,-86]},{xVal:n("2015"),yVal:4E3,path:"M131,101L118,82",text:"Min Snow Levels",textOffset:[100,119]}],q=[{xVal:n("2011"),yVal:8E3,path:"M70,19L105,156",text:"Max Snow Levels",textOffset:[18,9]},{xVal:n("2015"),yVal:4E3,path:"M131,101L118,82",text:"Min Snow Levels",textOffset:[100,119]}],M=m.filter(function(a){return"dew"===a.type}),N=m.filter(function(a){return"reyw"===
    a.type&&"American"===a.river});a(d,C,"#year",!1,"sm",p);a(M,D,"#states_cal",!0,"sm",q);a(N,y,"#river_year_chart",!1,"sm");l(e,A,"American");d3.selectAll(".btn-group").on("click",function(c){var b=d3.event.target.id,g=b.split("-");c=g[1];var e=!1,b=/s/.test(b),f,d;"river"===g[0]?(f=/_/.test(g[2])?g[2].split("_").map(function(a){_.capitalize(a)}).join(" "):_.capitalize(g[2]),d=b?"reys":"reyw",g=y,b="#river_year_chart"):"year"===g[0]?(d=b?"yes":"yew",g=C,b="#year"):(d=b?"des":"dew",g=D,b="#states_cal",
    e=!0);var h=m.filter(function(a){return void 0!==f?a.type===d&&a.river===f:a.type===d});a(h,g,b,e,c)});d3.select("#river").on("change",function(b){b=this.options[this.selectedIndex].innerHTML;var c=d3.select(this),d=c.prop("value");d3.selectAll("#river_name").text(b);c.prop("value","");b=m.filter(function(a){return"reyw"===a.type&&a.river===d});""!==d&&(d3.selectAll("#rivers button").each(function(){var a=d3.select(this),b=a.attr("id").split("-"),c;3===b.length&&b[2]!==d&&(c=/\s/.test(d)?d.replace(" ",
    "_"):d,a.attr("id",b[0]+"-"+b[1]+"-"+c))}),a(b,y,"#river_year_chart",!1,"sm"),l(e,A,d))});d=d3.selectAll(".row");d.classed("opaque",!1);d.classed("hide",!1);d3.selectAll("#load").classed("hide",!0)});l();window.addEventListener("resize",l)});